generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  personalInfo  PersonalInfo?
  conversations ConversationParticipant[]
  messages      Message[]
  messageReads  MessageRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PersonalInfo {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique @db.ObjectId

  firstName           String?
  lastName            String?
  phoneNumber         String?
  location            String?
  bio                 String?
  relationshipStatus  String?
  orientation         String?
  height              String?
  ethnicity           String?
  zodiacSign          String?
  favoriteColor       String?
  favoriteMovieOrShow String?
  petOwnership        String?
  profilePicture      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== CHAT MODELS ====================

model Conversation {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  name    String? // For group chats
  isGroup Boolean @default(false)

  participants ConversationParticipant[]
  messages     Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConversationParticipant {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String       @db.ObjectId

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  joinedAt   DateTime @default(now())
  lastReadAt DateTime @default(now())

  @@unique([conversationId, userId])
}

model Message {
  id      String      @id @default(auto()) @map("_id") @db.ObjectId
  content String
  type    MessageType @default(TEXT)

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String       @db.ObjectId

  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId String @db.ObjectId

  isEdited  Boolean @default(false)
  isDeleted Boolean @default(false)

  // For file attachments
  attachmentUrl  String?
  attachmentType String?

  readBy MessageRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MessageRead {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String  @db.ObjectId

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  readAt DateTime @default(now())

  @@unique([messageId, userId])
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}
